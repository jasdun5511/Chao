<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤ç‰©å¤§æˆ˜åƒµå°¸ - ç»ˆæä¿®å¤ç‰ˆ</title>
    <style>
        /* --- CSS æ ·å¼éƒ¨åˆ† --- */
        body {
            background-color: #222;
            color: white;
            font-family: 'Arial', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none; /* é˜²æ­¢åŒå‡»é€‰ä¸­æ–‡æœ¬ */
        }

        h1 { margin: 10px 0; font-size: 24px; }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .header {
            display: flex;
            gap: 20px;
            font-size: 20px;
            background: #444;
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid #666;
        }
        .sun { color: #FFD700; font-weight: bold; }

        /* æ¤ç‰©å¡æ§½ */
        .seed-bank {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .card {
            width: 70px;
            height: 90px;
            background: #9aa;
            border: 3px solid #555;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }
        .card:hover { transform: scale(1.05); }
        .card.active { 
            border-color: #FFD700; 
            background: #fff; 
            box-shadow: 0 0 15px #FFD700;
        }
        .card-emoji { font-size: 35px; }
        .card-cost { font-size: 14px; color: black; font-weight: bold; }

        /* æ¸¸æˆä¸»èˆå° */
        #game-board {
            position: relative;
            width: 800px;
            height: 500px;
            background-color: #4CAF50;
            border: 8px solid #3e2723;
            border-radius: 5px;
            display: grid;
            grid-template-rows: repeat(5, 1fr); /* 5è¡Œ */
            overflow: hidden; /* é˜²æ­¢åƒµå°¸è·‘å‡ºæ¡†å¤– */
        }

        /* æ¯ä¸€è¡Œ */
        .row {
            border-bottom: 1px dashed rgba(255,255,255,0.3);
            position: relative; /* ç”¨äºå®šä½è¡Œå†…çš„å…ƒç´  */
        }

        /* æ¸¸æˆå…ƒç´ é€šç”¨ */
        .element {
            position: absolute;
            width: 80px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            /* å±…ä¸­ä¿®æ­£ */
            top: 0;
        }

        .plant { left: 10px; z-index: 10; cursor: not-allowed; }
        .bullet { font-size: 20px; z-index: 5; width: 30px; height: 30px; top: 35px; }
        .zombie { right: -60px; z-index: 20; transition: transform 0.1s linear; }
        
        /* æç¤ºä¿¡æ¯ */
        #msg { height: 20px; color: #ffeb3b; margin-bottom: 5px; }

    </style>
</head>
<body>

    <h1>ğŸŒ» æ¤ç‰©å¤§æˆ˜åƒµå°¸ (ä¿®å¤ç‰ˆ) ğŸ§Ÿ</h1>
    
    <div class="header">
        <div class="sun">â˜€ï¸ é˜³å…‰: <span id="sun-count">150</span></div>
        <div class="score">å¾—åˆ†: <span id="score-count">0</span></div>
    </div>

    <div class="seed-bank">
        <div class="card" onclick="selectPlant('sunflower', 50, this)">
            <div class="card-emoji">ğŸŒ»</div>
            <div class="card-cost">50</div>
        </div>
        <div class="card" onclick="selectPlant('pea', 100, this)">
            <div class="card-emoji">ğŸŒ±</div>
            <div class="card-cost">100</div>
        </div>
        <div class="card" onclick="selectPlant('nut', 50, this)">
            <div class="card-emoji">ğŸŒ°</div>
            <div class="card-cost">50</div>
        </div>
    </div>

    <div id="msg">å…ˆç‚¹å‡»å¡ç‰‡ï¼Œå†ç‚¹å‡»è‰åªç§æ¤</div>

    <div id="game-board">
        <div class="row" id="row-0" onclick="plantHere(0)"></div>
        <div class="row" id="row-1" onclick="plantHere(1)"></div>
        <div class="row" id="row-2" onclick="plantHere(2)"></div>
        <div class="row" id="row-3" onclick="plantHere(3)"></div>
        <div class="row" id="row-4" onclick="plantHere(4)"></div>
    </div>

    <script>
        /* --- JavaScript é€»è¾‘éƒ¨åˆ† --- */
        
        // æ¸¸æˆæ•°æ®
        let sun = 150;
        let score = 0;
        let currentSelection = null; // å½“å‰é€‰ä¸­çš„æ¤ç‰© {type: 'pea', cost: 100}
        
        // æ¯ä¸€è¡Œçš„æ•°æ®çŠ¶æ€
        const rowsState = [
            { hasPlant: false, zombies: [], bullets: [] },
            { hasPlant: false, zombies: [], bullets: [] },
            { hasPlant: false, zombies: [], bullets: [] },
            { hasPlant: false, zombies: [], bullets: [] },
            { hasPlant: false, zombies: [], bullets: [] }
        ];

        // 1. é€‰æ‹©æ¤ç‰©åŠŸèƒ½
        function selectPlant(type, cost, cardElement) {
            // æ£€æŸ¥é’±å¤Ÿä¸å¤Ÿ
            if (sun < cost) {
                showMessage("é˜³å…‰ä¸è¶³ï¼", "red");
                return;
            }

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            currentSelection = { type: type, cost: cost };
            
            // UIæ›´æ–°ï¼šç§»é™¤å…¶ä»–å¡ç‰‡çš„é«˜äº®ï¼Œé«˜äº®å½“å‰å¡ç‰‡
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            cardElement.classList.add('active');
            
            showMessage("å·²é€‰æ‹©: " + type + "ï¼Œè¯·ç‚¹å‡»è‰åªï¼", "#fff");
        }

        // 2. ç§æ¤åŠŸèƒ½
        function plantHere(rowIndex) {
            // å¦‚æœæ²¡é€‰æ¤ç‰©ï¼Œæˆ–è€…è¿™è¡Œå·²ç»æœ‰æ¤ç‰©äº†ï¼Œå•¥ä¹Ÿä¸åš
            if (!currentSelection) return;
            if (rowsState[rowIndex].hasPlant) {
                showMessage("è¿™é‡Œå·²ç»æœ‰æ¤ç‰©äº†ï¼", "red");
                return;
            }

            // äºŒæ¬¡æ£€æŸ¥é’±å¤Ÿä¸å¤Ÿ
            if (sun < currentSelection.cost) {
                showMessage("é˜³å…‰ä¸è¶³ï¼", "red");
                return;
            }

            // æ‰£é’±
            sun -= currentSelection.cost;
            document.getElementById('sun-count').innerText = sun;

            // åˆ›å»ºæ¤ç‰©å…ƒç´ 
            const rowDiv = document.getElementById(`row-${rowIndex}`);
            const plantDiv = document.createElement('div');
            plantDiv.className = 'element plant';
            
            // æ ¹æ®ç±»å‹è®¾ç½®å›¾æ ‡å’Œå±æ€§
            let hp = 5;
            if (currentSelection.type === 'sunflower') {
                plantDiv.innerText = 'ğŸŒ»';
                // å‘æ—¥è‘µäº§é˜³å…‰é€»è¾‘
                const sunTimer = setInterval(() => {
                     // å¦‚æœæ¤ç‰©æ²¡äº†(è¢«åƒäº†)ï¼Œåœæ­¢äº§é˜³å…‰
                    if(!plantDiv.parentElement) clearInterval(sunTimer);
                    sun += 25;
                    document.getElementById('sun-count').innerText = sun;
                    // ç‰¹æ•ˆ
                    plantDiv.style.filter = "brightness(1.5)";
                    setTimeout(()=> plantDiv.style.filter = "none", 200);
                }, 4000);
            } 
            else if (currentSelection.type === 'pea') {
                plantDiv.innerText = 'ğŸŒ±';
                // å°„æ‰‹é€»è¾‘
                const shootTimer = setInterval(() => {
                    if(!plantDiv.parentElement) clearInterval(shootTimer);
                    // åªæœ‰å½“è¿™ä¸€è¡Œæœ‰åƒµå°¸æ—¶æ‰å°„å‡»
                    if(rowsState[rowIndex].zombies.length > 0) {
                        createBullet(rowIndex);
                    }
                }, 1500);
            }
            else if (currentSelection.type === 'nut') {
                plantDiv.innerText = 'ğŸŒ°';
                hp = 20; // åšæœè¡€åš
            }

            // æ·»åŠ åˆ°é¡µé¢
            rowDiv.appendChild(plantDiv);

            // æ›´æ–°æ•°æ®çŠ¶æ€
            rowsState[rowIndex].hasPlant = true;
            rowsState[rowIndex].plantElement = plantDiv; // ä¿å­˜å¼•ç”¨ä»¥ä¾¿åˆ é™¤
            rowsState[rowIndex].plantHp = hp;

            // é‡ç½®é€‰ä¸­çŠ¶æ€
            currentSelection = null;
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            showMessage("ç§æ¤æˆåŠŸï¼", "#4CAF50");
        }

        // 3. å­å¼¹é€»è¾‘
        function createBullet(rowIndex) {
            const rowDiv = document.getElementById(`row-${rowIndex}`);
            const bullet = document.createElement('div');
            bullet.className = 'element bullet';
            bullet.innerText = 'ğŸŸ¢';
            bullet.style.left = '60px';
            rowDiv.appendChild(bullet);

            // è®°å½•å­å¼¹
            rowsState[rowIndex].bullets.push({ el: bullet, left: 60 });
        }

        // 4. ç”Ÿæˆåƒµå°¸
        function spawnZombie() {
            const rowIndex = Math.floor(Math.random() * 5);
            const rowDiv = document.getElementById(`row-${rowIndex}`);
            
            const zombie = document.createElement('div');
            zombie.className = 'element zombie';
            zombie.innerText = 'ğŸ§Ÿ';
            zombie.style.left = '800px'; // èµ·å§‹ä½ç½®
            rowDiv.appendChild(zombie);

            rowsState[rowIndex].zombies.push({ el: zombie, left: 800, hp: 5 });
        }
        
        // æ¯3ç§’ç”Ÿæˆä¸€ä¸ªåƒµå°¸
        setInterval(spawnZombie, 3000);

        // 5. æ¸¸æˆä¸»å¾ªç¯ (æ¯20æ¯«ç§’åˆ·æ–°ä¸€æ¬¡ä½ç½®)
        setInterval(() => {
            rowsState.forEach((row, rIndex) => {
                
                // A. ç§»åŠ¨å­å¼¹
                for (let i = row.bullets.length - 1; i >= 0; i--) {
                    let b = row.bullets[i];
                    b.left += 5; // å­å¼¹é€Ÿåº¦
                    b.el.style.left = b.left + 'px';

                    // ç¢°æ’æ£€æµ‹
                    let hit = false;
                    for (let z of row.zombies) {
                        if (b.left >= z.left && b.left < z.left + 60) {
                            // æ‰“ä¸­äº†
                            hit = true;
                            z.hp--;
                            z.el.style.opacity = 0.5;
                            setTimeout(()=> z.el.style.opacity = 1, 100);
                            
                            if (z.hp <= 0) {
                                // åƒµå°¸æ­»
                                z.el.remove();
                                // ä»æ•°ç»„ç§»é™¤
                                const zIdx = row.zombies.indexOf(z);
                                if (zIdx > -1) row.zombies.splice(zIdx, 1);
                                score += 10;
                                document.getElementById('score-count').innerText = score;
                            }
                            break;
                        }
                    }

                    // å­å¼¹é£å‡ºå±å¹•æˆ–æ‰“ä¸­åç§»é™¤
                    if (b.left > 800 || hit) {
                        b.el.remove();
                        row.bullets.splice(i, 1);
                    }
                }

                // B. ç§»åŠ¨åƒµå°¸
                for (let i = row.zombies.length - 1; i >= 0; i--) {
                    let z = row.zombies[i];
                    
                    // å¦‚æœç¢°åˆ°æ¤ç‰©
                    if (row.hasPlant && z.left < 80) {
                        // åƒæ¤ç‰© (åƒµå°¸åœæ­¢ç§»åŠ¨)
                        // ç®€å•å¤„ç†ï¼šæ¯20å¸§æ‰£ä¸€æ¬¡è¡€ (çº¦0.5ç§’æ‰£ä¸€æ¬¡)
                        if (Math.random() < 0.05) {
                            row.plantHp--;
                            row.plantElement.style.opacity = 0.5;
                            setTimeout(()=> row.plantElement.style.opacity = 1, 100);

                            if (row.plantHp <= 0) {
                                // æ¤ç‰©è¢«åƒ
                                row.plantElement.remove();
                                row.hasPlant = false;
                                row.plantElement = null;
                            }
                        }
                    } else {
                        // æ­£å¸¸ç§»åŠ¨
                        z.left -= 1; 
                        z.el.style.left = z.left + 'px';
                    }

                    // è¾“æ‰æ¸¸æˆ
                    if (z.left < -50) {
                        alert("ğŸ§  åƒµå°¸åƒæ‰äº†ä½ çš„è„‘å­ï¼æ¸¸æˆç»“æŸã€‚");
                        location.reload();
                    }
                }
            });
        }, 30); // 30ms åˆ·æ–°ä¸€æ¬¡

        // è¾…åŠ©ï¼šæ˜¾ç¤ºä¿¡æ¯
        function showMessage(text, color) {
            const msg = document.getElementById('msg');
            msg.innerText = text;
            msg.style.color = color || 'white';
        }

    </script>
</body>
</html>

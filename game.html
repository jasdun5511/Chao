<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¤ç‰©å¤§æˆ˜å§œä¸ç‚’è‚‰ - æ‰‹æœºé‡åˆ¶ç‰ˆ</title>
    <style>
        /* --- 1. å…¨å±€ä¸æ‰‹æœºé€‚é…é‡ç½® --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: #1a1a1a;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0; padding: 0;
            overflow: hidden; /* ç¦æ­¢æ»šåŠ¨ */
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            touch-action: none; /* ç¦æ­¢é»˜è®¤è§¦æ§è¡Œä¸º */
            background-image: radial-gradient(circle at center, #2c3e50, #000);
        }

        /* --- 2. æ¸¸æˆå®¹å™¨ (è‡ªåŠ¨ç¼©æ”¾æ ¸å¿ƒ) --- */
        #app-container {
            width: 960px; /* è®¾è®¡åŸºå‡†å®½åº¦ */
            height: 640px; /* è®¾è®¡åŸºå‡†é«˜åº¦ */
            position: relative;
            background: #4CAF50;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border-radius: 12px;
            overflow: hidden;
            transform-origin: center center;
            /* èƒŒæ™¯çº¹ç†ï¼šè‰åªæ ¼å­ */
            background-image: 
                linear-gradient(45deg, #43A047 25%, transparent 25%, transparent 75%, #43A047 75%, #43A047),
                linear-gradient(45deg, #43A047 25%, transparent 25%, transparent 75%, #43A047 75%, #43A047);
            background-size: 200px 200px;
            background-position: 0 0, 100px 100px;
        }

        /* --- 3. é¡¶éƒ¨ UI æ  --- */
        .top-hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .hud-item {
            font-size: 20px; font-weight: bold;
            display: flex; align-items: center; gap: 8px;
            text-shadow: 1px 1px 2px black;
        }
        .sun-icon { color: #FFD700; font-size: 24px; animation: pulse 2s infinite; }
        .score-val { color: #fff; }

        /* --- 4. æ¸¸æˆä¸»èˆå° (ç»å¯¹å®šä½å±‚) --- */
        #game-board {
            position: absolute; top: 60px; left: 30px; /* ç•™å‡ºè¾¹è· */
            width: 900px; height: 500px; /* 9x5 æ ¼å­, æ¯ä¸ª100x100 */
            z-index: 10;
        }
        
        /* è¾…åŠ©ç½‘æ ¼çº¿ (ä»…æ˜¾ç¤ºï¼Œä¸äº¤äº’) */
        .grid-lines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(5, 1fr);
            pointer-events: none;
        }
        .grid-cell { border: 1px solid rgba(255,255,255,0.05); }
        /* é€‰ä¸­é«˜äº® */
        .grid-cell.highlight { background: rgba(255, 255, 255, 0.2); box-shadow: inset 0 0 15px rgba(255,255,255,0.4); }

        /* --- 5. åº•éƒ¨å¡ç‰Œæ  (å…³é”®ï¼šå¤§æ‹‡æŒ‡åŒºåŸŸ) --- */
        .bottom-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 110px;
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(10px);
            display: flex; justify-content: center; align-items: center; gap: 10px;
            z-index: 100;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 5px; /* é€‚é… iPhone åº•éƒ¨æ¨ªæ¡ */
        }

        .card {
            width: 80px; height: 90px;
            background: #2c3e50;
            border-radius: 8px;
            border: 2px solid #555;
            position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.1s;
            cursor: pointer;
            overflow: hidden;
        }
        .card:active { transform: scale(0.95); }
        .card.selected { 
            border-color: #FFD700; background: #34495e; 
            box-shadow: 0 0 15px #FFD700; transform: translateY(-5px);
        }
        .card.disabled { opacity: 0.5; filter: grayscale(0.8); }
        
        .card-icon { font-size: 40px; z-index: 2; }
        .card-cost { 
            font-size: 14px; color: #FFD700; font-weight: bold; 
            margin-top: 5px; z-index: 2; text-shadow: 1px 1px 0 #000;
        }
        
        /* å†·å´é®ç½© */
        .cooldown-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1;
            transition: height 0.1s linear;
        }

        /* --- 6. æ¸¸æˆå…ƒç´  (å®ä½“) --- */
        .entity {
            position: absolute;
            width: 100px; height: 100px; /* å æ»¡æ ¼å­ */
            display: flex; align-items: center; justify-content: center;
            font-size: 60px;
            pointer-events: none; /* ç©¿é€ç‚¹å‡» */
            z-index: 20;
            will-change: transform, left, top;
        }
        
        /* åŠ¨ç”»ç‰¹æ•ˆ */
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .zombie-anim { animation: bounce 0.5s infinite ease-in-out; }
        
        .bullet { width: 30px; height: 30px; font-size: 25px; z-index: 15; }
        
        /* è¡€æ¡ */
        .hp-container {
            position: absolute; top: 10px; left: 15px; width: 70px; height: 6px;
            background: rgba(0,0,0,0.5); border-radius: 3px; overflow: hidden;
            display: none; /* é»˜è®¤éšè—ï¼Œå—ä¼¤æ˜¾ç¤º */
        }
        .hp-bar { height: 100%; background: #00ff00; width: 100%; transition: width 0.1s; }
        .zombie .hp-container { display: block; top: 0; } /* åƒµå°¸å¸¸é©»è¡€æ¡ */
        
        /* å†°å†»æ•ˆæœ */
        .frozen { filter: hue-rotate(180deg) brightness(1.3) drop-shadow(0 0 5px blue); }

        /* --- 7. å¼¹çª— UI --- */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }
        .modal.hidden { display: none; }
        .modal h1 { font-size: 48px; color: #FF9800; margin-bottom: 20px; text-shadow: 0 0 20px orangered; }
        .btn {
            padding: 15px 40px; font-size: 24px;
            background: linear-gradient(to bottom, #4CAF50, #2E7D32);
            color: white; border: none; border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            cursor: pointer; font-weight: bold;
        }
        .btn:active { transform: scale(0.95); }

        /* æç¤ºä¿¡æ¯ */
        #toast {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 15px 30px; border-radius: 30px;
            font-size: 20px; font-weight: bold;
            pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 500;
        }
    </style>
</head>
<body>

    <div id="app-container">
        
        <div class="top-hud">
            <div class="hud-item"><span class="sun-icon">â˜€ï¸</span> <span id="ui-sun">150</span></div>
            <div class="hud-item">WAVE: <span id="ui-wave">1</span></div>
            <div class="hud-item">SCORE: <span id="ui-score">0</span></div>
        </div>

        <div id="game-board">
            <div class="grid-lines" id="grid-layer">
                </div>
            </div>

        <div class="bottom-bar" id="seed-bank">
            </div>

        <div id="toast"></div>

        <div id="start-screen" class="modal">
            <h1>æ¤ç‰©å¤§æˆ˜å§œä¸ç‚’è‚‰</h1>
            <p style="color:#aaa; margin-bottom: 30px;">æ‰‹æœºç‰¹åˆ«é‡åˆ¶ç‰ˆ v1.0</p>
            <button class="btn" onclick="startGame()">å¼€å§‹çƒ¹é¥ª</button>
        </div>
        
        <div id="game-over-screen" class="modal hidden">
            <h1 style="color: red;">è„‘å­è¢«åƒäº†!</h1>
            <div style="font-size: 24px; margin-bottom: 30px;">æœ€ç»ˆå¾—åˆ†: <span id="final-score">0</span></div>
            <button class="btn" onclick="location.reload()">å†è¯•ä¸€æ¬¡</button>
        </div>

    </div>

    <script>
        // ================= é…ç½®ä¸æ•°æ® =================
        const CONFIG = {
            width: 960, height: 640,
            gridRows: 5, gridCols: 9,
            cellSize: 100,
            tickRate: 20, // 50FPS
            waveInterval: 30000 // 30ç§’ä¸€æ³¢éš¾åº¦æå‡
        };

        const PLANTS_DATA = {
            'sunflower': { icon: 'ğŸŒ»', cost: 50, hp: 30, cd: 5000 },
            'pea':       { icon: 'ğŸŒ±', cost: 100, hp: 50, cd: 7000 },
            'ice':       { icon: 'ğŸ§Š', cost: 175, hp: 50, cd: 7000 },
            'nut':       { icon: 'ğŸŒ°', cost: 50,  hp: 400, cd: 10000 },
            'spikeweed': { icon: 'ğŸ”º', cost: 75,  hp: 100, cd: 10000 },
            'bomb':      { icon: 'ğŸ’', cost: 150, hp: 10,  cd: 30000 }
        };

        // æ¸¸æˆçŠ¶æ€
        let state = {
            active: false,
            sun: 150,
            score: 0,
            wave: 1,
            zombies: [],
            bullets: [],
            plants: [], // ä½¿ç”¨æ•°ç»„å­˜å‚¨ï¼Œæ¯ä¸ªå¸¦ä½ç½®ä¿¡æ¯
            selection: null, // å½“å‰é€‰ä¸­çš„å¡ç‰‡ {type, cost}
            spawnRate: 5000,
            baseSpeed: 0.5,
            spawnTimer: null,
            difficultyTimer: null,
            sunTimer: null,
            gameLoopId: null,
            cardCooldowns: {} // è®°å½•ä¸Šæ¬¡ä½¿ç”¨æ—¶é—´
        };

        // DOM å…ƒç´ 
        const $app = document.getElementById('app-container');
        const $board = document.getElementById('game-board');
        const $gridLayer = document.getElementById('grid-layer');
        const $seedBank = document.getElementById('seed-bank');
        const $uiSun = document.getElementById('ui-sun');
        const $uiScore = document.getElementById('ui-score');
        const $uiWave = document.getElementById('ui-wave');

        // ================= æ ¸å¿ƒï¼šå±å¹•é€‚é… (æ‰‹æœºå…³é”®) =================
        function resize() {
            const scaleX = window.innerWidth / CONFIG.width;
            const scaleY = window.innerHeight / CONFIG.height;
            const scale = Math.min(scaleX, scaleY); // ä¿æŒæ¯”ä¾‹
            $app.style.transform = `scale(${scale})`;
        }
        window.addEventListener('resize', resize);
        resize(); // Init

        // ================= åˆå§‹åŒ–é€»è¾‘ =================
        function initGrid() {
            $gridLayer.innerHTML = '';
            for (let r = 0; r < CONFIG.gridRows; r++) {
                for (let c = 0; c < CONFIG.gridCols; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šåœ¨æ£‹ç›˜ä¸Šç‚¹å‡»
                    cell.addEventListener('pointerdown', (e) => handleGridClick(r, c));
                    $gridLayer.appendChild(cell);
                }
            }
        }

        function initCards() {
            $seedBank.innerHTML = '';
            // åˆå§‹åŒ–å†·å´æ•°æ®
            Object.keys(PLANTS_DATA).forEach(key => {
                state.cardCooldowns[key] = 0; // 0 è¡¨ç¤ºå¯ç”¨
            });

            for (const [key, data] of Object.entries(PLANTS_DATA)) {
                const card = document.createElement('div');
                card.className = 'card';
                card.id = `card-${key}`;
                card.innerHTML = `
                    <div class="card-icon">${data.icon}</div>
                    <div class="card-cost">${data.cost}</div>
                    <div class="cooldown-overlay" id="cd-${key}"></div>
                `;
                card.addEventListener('pointerdown', () => selectCard(key));
                $seedBank.appendChild(card);
            }
        }

        // ================= æ¸¸æˆäº¤äº’ =================
        function selectCard(type) {
            if (!state.active) return;
            const now = Date.now();
            const data = PLANTS_DATA[type];
            
            // æ£€æŸ¥å†·å´
            if (now < state.cardCooldowns[type]) {
                showToast("å¡ç‰‡å†·å´ä¸­...");
                return;
            }
            // æ£€æŸ¥é˜³å…‰
            if (state.sun < data.cost) {
                showToast("é˜³å…‰ä¸è¶³!", "red");
                return;
            }

            // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
            if (state.selection && state.selection.type === type) {
                state.selection = null; // å–æ¶ˆé€‰ä¸­
                updateCardVisuals();
                highlightGrid(false);
            } else {
                state.selection = { type, cost: data.cost };
                updateCardVisuals();
                highlightGrid(true); // é«˜äº®æ ¼å­æç¤ºæ”¾ç½®
                showToast(`å·²é€‰æ‹© ${data.icon}`);
            }
        }

        function handleGridClick(r, c) {
            if (!state.active || !state.selection) return;

            // æ£€æŸ¥è¯¥ä½ç½®æ˜¯å¦æœ‰æ¤ç‰©
            const existing = state.plants.find(p => p.r === r && p.c === c);
            if (existing) {
                showToast("è¿™é‡Œå·²ç»æœ‰æ¤ç‰©äº†");
                return;
            }

            // å†æ¬¡æ£€æŸ¥é˜³å…‰ (é˜²æ­¢æ‰‹å¿«)
            if (state.sun < state.selection.cost) return;

            // --- ç§æ¤æˆåŠŸ ---
            const type = state.selection.type;
            const now = Date.now();

            // 1. æ‰£è´¹
            state.sun -= state.selection.cost;
            // 2. è®¾å†·å´
            state.cardCooldowns[type] = now + PLANTS_DATA[type].cd;
            
            // 3. ç”Ÿæˆå®ä½“
            spawnPlant(r, c, type);

            // 4. é‡ç½®çŠ¶æ€
            state.selection = null;
            updateUI();
            updateCardVisuals();
            highlightGrid(false);
            
            // éœ‡åŠ¨åé¦ˆ (å¦‚æœè®¾å¤‡æ”¯æŒ)
            if (navigator.vibrate) navigator.vibrate(20);
        }

        // ================= å®ä½“ç”Ÿæˆ =================
        function spawnPlant(r, c, type) {
            const el = document.createElement('div');
            el.className = 'entity';
            el.innerText = PLANTS_DATA[type].icon;
            
            // å¢åŠ è¡€æ¡UI
            const hpBar = document.createElement('div');
            hpBar.className = 'hp-container';
            hpBar.innerHTML = `<div class="hp-bar"></div>`;
            el.appendChild(hpBar);

            // ç»å¯¹å®šä½åˆ°æ£‹ç›˜
            el.style.left = (c * 100) + 'px';
            el.style.top = (r * 100) + 'px';
            
            // ç‰¹æ•ˆï¼šè½åœ°åŠ¨ç”»
            el.style.transform = "scale(0)";
            el.style.transition = "transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
            requestAnimationFrame(() => el.style.transform = "scale(1)");

            $board.appendChild(el);

            const plantObj = {
                id: Math.random(), r, c, type,
                hp: PLANTS_DATA[type].hp, maxHp: PLANTS_DATA[type].hp,
                el, hpBar: hpBar.querySelector('.hp-bar'),
                lastAction: 0 // ä¸Šæ¬¡æ”»å‡»æ—¶é—´
            };

            // ç‰¹æ®Šæ¤ç‰©é€»è¾‘ (ç‚¸å¼¹å»¶æ—¶)
            if (type === 'bomb') {
                setTimeout(() => { if (plantObj.hp > 0) explode(plantObj); }, 2000);
            }

            state.plants.push(plantObj);
        }

        function spawnZombie() {
            if (!state.active) return;
            const r = Math.floor(Math.random() * CONFIG.gridRows);
            const el = document.createElement('div');
            el.className = 'entity zombie zombie-anim';
            
            // éšæœºç±»å‹
            const rand = Math.random();
            let type = 'normal';
            let hp = 10; // åŸºç¡€è¡€é‡
            let speed = state.baseSpeed;
            let symbol = 'ğŸ·';

            // åŠ¨æ€éš¾åº¦ï¼šè±Œè±†å°„æ‰‹åƒµå°¸
            if (rand < 0.1) {
                type = 'shooter'; hp = 12; speed = state.baseSpeed * 0.6; symbol = 'ğŸ”«';
            } else if (rand < 0.25) {
                type = 'bucket'; hp = 50; speed = state.baseSpeed * 0.7; symbol = 'ğŸ‘º';
            } else if (rand < 0.5) {
                type = 'cone'; hp = 25; speed = state.baseSpeed * 0.8; symbol = 'â›‘ï¸';
            }

            el.innerText = symbol;
            
            // è¡€æ¡
            const hpBar = document.createElement('div');
            hpBar.className = 'hp-container';
            hpBar.innerHTML = `<div class="hp-bar"></div>`;
            el.appendChild(hpBar);

            // åˆå§‹ä½ç½®ï¼šå±å¹•å³å¤–ä¾§
            const x = 900; 
            const y = r * 100;
            el.style.left = x + 'px';
            el.style.top = y + 'px';

            $board.appendChild(el);

            state.zombies.push({
                x, y, r, el, hp, maxHp: hp, type,
                speed, hpBar: hpBar.querySelector('.hp-bar'),
                freezeTimer: 0,
                attackCd: 0,
                shootCd: 0 // å°„æ‰‹ä¸“ç”¨
            });
        }

        function spawnBullet(r, x, isIce, isEnemy) {
            const el = document.createElement('div');
            el.className = 'entity bullet';
            el.innerText = isEnemy ? 'ğŸ”´' : (isIce ? 'ğŸ”µ' : 'ğŸŸ¢');
            el.style.left = x + 'px';
            el.style.top = (r * 100 + 35) + 'px'; // å¾®è°ƒå‚ç›´å±…ä¸­
            el.style.zIndex = 30;
            
            $board.appendChild(el);

            state.bullets.push({
                x, r, el, isIce, isEnemy
            });
        }

        // ================= æ ¸å¿ƒæ¸¸æˆå¾ªç¯ =================
        function gameLoop() {
            if (!state.active) return;
            const now = Date.now();

            // --- 1. æ¤ç‰©é€»è¾‘ ---
            state.plants.forEach(p => {
                // åœ°åˆºé€»è¾‘
                if (p.type === 'spikeweed') {
                    if (now - p.lastAction > 1000) { // æ¯ç§’ä¸€ä¼¤
                        state.zombies.forEach(z => {
                            const zCol = Math.floor((z.x + 50) / 100);
                            if (z.r === p.r && zCol === p.c) takeDamage(z, 2);
                        });
                        p.lastAction = now;
                    }
                    return;
                }

                // æ”»å‡»é€»è¾‘ (å‘æ—¥è‘µ/å°„æ‰‹)
                let cd = (p.type === 'sunflower') ? 3000 : 1200; // æ”»é€Ÿ
                if (now - p.lastAction > cd) {
                    if (p.type === 'sunflower') {
                        // äº§é˜³å…‰åŠ¨ç”»
                        state.sun += 25;
                        showFloatingText("+25", p.c*100, p.r*100, "#FFD700");
                        updateUI();
                        updateCardVisuals();
                        p.lastAction = now;
                    } else if (p.type === 'pea' || p.type === 'ice') {
                        // ç´¢æ•Œï¼šæœ¬è¡Œå³ä¾§æœ‰åƒµå°¸
                        const hasEnemy = state.zombies.some(z => z.r === p.r && z.x > p.c * 100);
                        if (hasEnemy) {
                            spawnBullet(p.r, p.c * 100 + 60, p.type === 'ice', false);
                            p.lastAction = now;
                            // æ”»å‡»åŠ¨ç”»
                            p.el.style.transform = "scale(1.2)";
                            setTimeout(() => p.el.style.transform = "scale(1)", 100);
                        }
                    }
                }
            });

            // --- 2. åƒµå°¸é€»è¾‘ ---
            state.zombies.forEach(z => {
                let moveSpeed = z.speed;
                // å†°å†»å‡é€Ÿ
                if (z.freezeTimer > 0) {
                    moveSpeed *= 0.5;
                    z.freezeTimer--;
                    if (z.freezeTimer === 0) z.el.classList.remove('frozen');
                } else {
                    z.el.classList.remove('frozen');
                }

                // è®¡ç®—å½“å‰æ ¼å­
                const col = Math.floor((z.x + 40) / 100); // ç¢°æ’ä¸­å¿ƒç‚¹
                const plant = state.plants.find(p => p.r === z.r && p.c === col);

                // 2.1 å°„æ‰‹åƒµå°¸è¡Œä¸º
                if (z.type === 'shooter') {
                    // å¦‚æœå‰æ–¹æœ‰æ¤ç‰©ï¼Œä¸”è·ç¦»åœ¨ 2-8 æ ¼ä¹‹é—´
                    const targetPlant = state.plants.find(p => p.r === z.r && p.c * 100 < z.x);
                    if (targetPlant && (z.x - targetPlant.c*100 > 150)) {
                        moveSpeed = 0; // åœä¸‹
                        if (z.shootCd <= 0) {
                            spawnBullet(z.r, z.x, false, true); // å‘å°„çº¢è‰²å­å¼¹
                            z.shootCd = 60; // å†·å´
                        } else {
                            z.shootCd--;
                        }
                    }
                }

                // 2.2 å•ƒé£Ÿé€»è¾‘
                let isEating = false;
                if (plant) {
                    // è¿›å…¥å•ƒé£ŸèŒƒå›´
                    if (z.x < col * 100 + 60) {
                        moveSpeed = 0;
                        isEating = true;
                        if (z.attackCd <= 0) {
                            takeDamage(plant, 10); // å•ƒä¸€å£
                            z.attackCd = 30; // æ”»é€Ÿ
                            
                            // å•ƒé£ŸåŠ¨ç”»
                            z.el.style.transform = "translateX(-5px)";
                            setTimeout(() => z.el.style.transform = "translateX(0)", 100);
                        } else {
                            z.attackCd--;
                        }
                    }
                }

                // 2.3 ç§»åŠ¨
                if (!isEating) {
                    z.x -= moveSpeed;
                    z.el.style.left = z.x + 'px';
                }

                // 2.4 è¾“æ‰æ¸¸æˆ
                if (z.x < -50) gameOver();
            });

            // --- 3. å­å¼¹é€»è¾‘ ---
            state.bullets.forEach((b, idx) => {
                if (b.isEnemy) {
                    b.x -= 6; // å‘å·¦é£
                    // å‡»ä¸­æ¤ç‰©åˆ¤å®š
                    const col = Math.floor((b.x + 30) / 100);
                    const plant = state.plants.find(p => p.r === b.r && p.c === col);
                    if (plant && b.x < col * 100 + 80) {
                        takeDamage(plant, 15);
                        removeBullet(idx);
                        return; // é€€å‡ºå½“å‰å­å¼¹é€»è¾‘
                    }
                } else {
                    b.x += 8; // å‘å³é£
                    // å‡»ä¸­åƒµå°¸åˆ¤å®š
                    const target = state.zombies.find(z => z.r === b.r && b.x > z.x + 20 && b.x < z.x + 80);
                    if (target) {
                        takeDamage(target, 10);
                        if (b.isIce) {
                            target.freezeTimer = 100;
                            target.el.classList.add('frozen');
                        }
                        removeBullet(idx);
                        return;
                    }
                }
                
                b.el.style.left = b.x + 'px';
                // é£å‡ºè¾¹ç•Œ
                if (b.x > 1000 || b.x < -50) removeBullet(idx);
            });

            // æ¸…ç†æ­»äº¡å•ä½
            cleanupDead();
        }

        // ================= è¾…åŠ©å‡½æ•° =================
        function takeDamage(entity, amount) {
            entity.hp -= amount;
            // æ›´æ–°è¡€æ¡
            const pct = Math.max(0, (entity.hp / entity.maxHp) * 100);
            entity.hpBar.style.width = pct + '%';
            if (pct < 50) entity.hpBar.style.background = "orange";
            if (pct < 20) entity.hpBar.style.background = "red";

            // å—ä¼¤é—ªç™½
            entity.el.style.filter = "brightness(2)";
            setTimeout(() => {
                if(entity.el) entity.el.style.filter = entity.freezeTimer > 0 ? "hue-rotate(180deg) brightness(1.3)" : "none";
            }, 50);
        }

        function explode(bomb) {
            // è§†è§‰ç‰¹æ•ˆ
            const blast = document.createElement('div');
            blast.innerHTML = 'ğŸ’¥';
            blast.style.position = 'absolute';
            blast.style.fontSize = '150px';
            blast.style.left = (bomb.c * 100 - 25) + 'px';
            blast.style.top = (bomb.r * 100 - 25) + 'px';
            blast.style.zIndex = 100;
            $board.appendChild(blast);
            setTimeout(() => blast.remove(), 500);
            
            // èŒƒå›´ä¼¤å®³ 3x3
            state.zombies.forEach(z => {
                const zCol = Math.floor((z.x + 40) / 100);
                if (Math.abs(z.r - bomb.r) <= 1 && Math.abs(zCol - bomb.c) <= 1) {
                    takeDamage(z, 500); // ç§’æ€
                }
            });
            
            // ç‚¸å¼¹è‡ªæ¯
            bomb.hp = 0;
            // éœ‡åŠ¨
            if (navigator.vibrate) navigator.vibrate(200);
        }

        function removeBullet(index) {
            const b = state.bullets[index];
            if (b && b.el) b.el.remove();
            state.bullets[index] = null; // æ ‡è®°åˆ é™¤
        }

        function cleanupDead() {
            // æ¸…ç†å­å¼¹
            state.bullets = state.bullets.filter(b => b !== null);
            
            // æ¸…ç†åƒµå°¸
            state.zombies = state.zombies.filter(z => {
                if (z.hp <= 0) {
                    z.el.remove();
                    state.score += 10;
                    updateUI();
                    return false;
                }
                return true;
            });
            
            // æ¸…ç†æ¤ç‰©
            state.plants = state.plants.filter(p => {
                if (p.hp <= 0) {
                    p.el.remove();
                    return false;
                }
                return true;
            });
        }

        function updateUI() {
            $uiSun.innerText = Math.floor(state.sun);
            $uiScore.innerText = state.score;
            $uiWave.innerText = state.wave;
        }

        function updateCardVisuals() {
            const now = Date.now();
            Object.keys(PLANTS_DATA).forEach(type => {
                const card = document.getElementById(`card-${type}`);
                const overlay = document.getElementById(`cd-${type}`);
                const data = PLANTS_DATA[type];
                const cdEnd = state.cardCooldowns[type];
                
                // å¤„ç†å†·å´é®ç½©
                if (now < cdEnd) {
                    const totalCd = data.cd;
                    const left = cdEnd - now;
                    const pct = (left / totalCd) * 100;
                    overlay.style.height = `${pct}%`;
                    card.classList.add('disabled');
                } else {
                    overlay.style.height = '0%';
                    // æ£€æŸ¥é˜³å…‰
                    if (state.sun < data.cost) card.classList.add('disabled');
                    else card.classList.remove('disabled');
                }

                // å¤„ç†é€‰ä¸­çŠ¶æ€
                if (state.selection && state.selection.type === type) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
            
            if (state.active) requestAnimationFrame(updateCardVisuals);
        }
        
        function highlightGrid(active) {
            const cells = document.querySelectorAll('.grid-cell');
            cells.forEach(c => {
                if(active) c.classList.add('highlight');
                else c.classList.remove('highlight');
            });
        }

        function showFloatingText(text, x, y, color) {
            const el = document.createElement('div');
            el.innerText = text;
            el.style.position = 'absolute';
            el.style.left = (x + 20) + 'px';
            el.style.top = y + 'px';
            el.style.color = color;
            el.style.fontSize = '24px';
            el.style.fontWeight = 'bold';
            el.style.textShadow = '1px 1px 0 #000';
            el.style.zIndex = 200;
            el.style.transition = 'all 1s';
            $board.appendChild(el);
            
            // æµ®åŠ¨åŠ¨ç”»
            requestAnimationFrame(() => {
                el.style.top = (y - 50) + 'px';
                el.style.opacity = 0;
            });
            setTimeout(() => el.remove(), 1000);
        }
        
        function showToast(msg, color='white') {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.color = color;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 1500);
        }

        // ================= æ¸¸æˆæµç¨‹æ§åˆ¶ =================
        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            state.active = true;
            initGrid();
            initCards();
            
            // å¯åŠ¨å¾ªç¯
            state.gameLoopId = setInterval(gameLoop, CONFIG.tickRate);
            
            // å¯åŠ¨ç”Ÿæˆå™¨
            state.spawnTimer = setInterval(spawnZombie, state.spawnRate);
            
            // è‡ªç„¶é˜³å…‰
            state.sunTimer = setInterval(() => {
                state.sun += 25;
                updateUI();
                showFloatingText("+25", 400, 0, "#FFD700"); // ä»é¡¶éƒ¨æ‰è½
            }, 5000);
            
            // éš¾åº¦æå‡
            state.difficultyTimer = setInterval(() => {
                state.wave++;
                state.baseSpeed += 0.1;
                state.spawnRate = Math.max(1000, state.spawnRate - 500);
                
                // é‡ç½®ç”Ÿæˆå™¨ä»¥åº”ç”¨æ–°é€Ÿåº¦
                clearInterval(state.spawnTimer);
                state.spawnTimer = setInterval(spawnZombie, state.spawnRate);
                
                showToast(`ç¬¬ ${state.wave} æ³¢è¿›æ”»!`, "red");
                updateUI();
            }, CONFIG.waveInterval);

            updateCardVisuals(); // å¯åŠ¨è§†è§‰å¾ªç¯
        }

        function gameOver() {
            state.active = false;
            clearInterval(state.gameLoopId);
            clearInterval(state.spawnTimer);
            clearInterval(state.difficultyTimer);
            clearInterval(state.sunTimer);
            
            document.getElementById('final-score').innerText = state.score;
            document.getElementById('game-over-screen').classList.remove('hidden');
        }

    </script>
</body>
</html>

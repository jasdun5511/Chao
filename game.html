<script>
    // --- 游戏画面缩放和初始化 ---
    function resizeGame() {
        const wrapper = document.getElementById('game-wrapper');
        const targetWidth = 940; 
        const screenWidth = window.innerWidth;
        if (screenWidth < targetWidth) {
            const scale = screenWidth / targetWidth;
            wrapper.style.transform = `scale(${scale})`;
        } else {
            wrapper.style.transform = `scale(1)`;
        }
    }
    window.addEventListener('resize', resizeGame);
    resizeGame();

    const board = document.getElementById('game-board');
    const sunText = document.getElementById('sun-count');
    const scoreText = document.getElementById('score-count');
    const msgText = document.getElementById('msg');

    let sun = 150;
    let score = 0;
    let selection = null;
    let gameActive = true;

    // --- 难度控制变量 ---
    let difficultyLevel = 0;
    let baseZombieSpeed = 0.5; // 初始速度：0.5
    let normalSpawnRate = 5000; // 初始生成间隔：5000ms (5秒)
    let spawnIntervalId = null; 
    // ----------------------
   
    const grid = Array(5).fill(null).map(() => Array(9).fill(null));
    const zombies = []; 
    const bullets = []; 

    // --- 卡片冷却状态 ---
    const cardCooldowns = {
        'sunflower': { time: 5000, remaining: 0, el: document.getElementById('card-sunflower') },
        'pea': { time: 7000, remaining: 0, el: document.getElementById('card-pea') },
        'ice': { time: 7000, remaining: 0, el: document.getElementById('card-ice') },
        'nut': { time: 10000, remaining: 0, el: document.getElementById('card-nut') },
        'bomb': { time: 30000, remaining: 0, el: document.getElementById('card-bomb') }
    };

    for (let r = 0; r < 5; r++) {
        for (let c = 0; c < 9; c++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.id = `cell-${r}-${c}`;
            cell.dataset.r = r;
            cell.dataset.c = c;
            cell.addEventListener('click', () => handleCellClick(r, c));
            board.appendChild(cell);
        }
    }

    const STORAGE_KEY = 'pvz_pork_scores_v3'; 
    function loadScores() {
        const savedScores = localStorage.getItem(STORAGE_KEY);
        return savedScores ? JSON.parse(savedScores) : [];
    }
    function saveScore(newScore) {
        let scores = loadScores();
        if (scores.length >= 5 && newScore < scores[scores.length - 1].score) return;
        const playerName = prompt(`游戏结束！得分: ${newScore}\n请输入大厨名字上榜：`, "大厨") || "匿名大厨";
        scores.push({ name: playerName, score: newScore });
        scores.sort((a, b) => b.score - a.score);
        scores = scores.slice(0, 5);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(scores));
        displayLeaderboard();
    }
    function displayLeaderboard() {
        const scoresList = document.getElementById('scores-list');
        const scores = loadScores();
        scoresList.innerHTML = '';
        if (scores.length === 0) scoresList.innerHTML = '<li>暂无记录</li>';
        scores.forEach((item, index) => {
            const li = document.createElement('li');
            li.innerHTML = `<span>#${index + 1} ${item.name}</span> <span style="color:#FFD700">${item.score}</span>`;
            scoresList.appendChild(li);
        });
    }

    function updateCards() {
        for (const type in cardCooldowns) {
            const cd = cardCooldowns[type];
            const cardEl = cd.el;
            const cost = parseInt(cardEl.querySelector('.card-cost').innerText);
            
            const isDisabled = sun < cost || cd.remaining > 0;

            const cdBar = cardEl.querySelector('.card-cooldown-bar');
            if (cd.remaining > 0) {
                const percentage = (cd.remaining / cd.time) * 100;
                cdBar.style.height = `${percentage}%`;
                cardEl.classList.add('cooling');
            } else {
                cdBar.style.height = '0';
                cardEl.classList.remove('cooling');
            }

            if (sun < cost) {
                cardEl.classList.add('disabled');
            } else {
                cardEl.classList.remove('disabled');
            }
        }
    }

    window.selectCard = function(type, cost) {
        if (!gameActive) return;
        
        const cd = cardCooldowns[type];
        if (cd.remaining > 0) { showMessage("卡片冷却中！", "orange"); return; }
        if (sun < cost) { showMessage("阳光不足！", "red"); return; }
        
        selection = { type, cost };
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        document.getElementById(`card-${type}`).classList.add('active');
        document.querySelectorAll('.cell').forEach(c => c.classList.add('active-zone'));
        showMessage(`已选择 ${type}`, "#fff");
    }

    function handleCellClick(r, c) {
        if (!gameActive || !selection) return;
        if (grid[r][c]) { showMessage("此地已有植物", "red"); return; }
        
        const type = selection.type;
   